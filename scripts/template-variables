### Defaults

# used for calculation of automatic port forwarding in vagrant environments
INDEX="${INDEX:-0}"
PORT_OFFSET="${PORT_OFFSET:-10}"

PROJECT_PATH="${PROJECT_PATH:-$(realpath $(dirname $(dirname $0)))}"
UNIX_PROJECT_PATH="${UNIX_PROJECT_PATH:-$(realpath $(dirname $(dirname $0)))}"

OMS_SKIP_BUSINESS_CONFIG="${OMS_SKIP_BUSINESS_CONFIG:--sb}"

# development host
HOST_IOM="${HOST_IOM:-localhost}"

# ports
PORT_IOM="${PORT_IOM:-8080}"
PORT_DEBUG="${PORT_DEBUG:-8787}"
PORT_DB="${PORT_DB:-5432}"
PORT_WILDFLY="${PORT_WILDFLY:-9990}"

### Dynamic variables

FORWARD_PORT_IOM=$(($PORT_IOM + ($INDEX * $PORT_OFFSET)))
FORWARD_PORT_DEBUG=$(($PORT_DEBUG + ($INDEX * $PORT_OFFSET)))
FORWARD_PORT_DB=$(($PORT_DB + ($INDEX * $PORT_OFFSET)))
FORWARD_PORT_WILDFLY=$(($PORT_WILDFLY + ($INDEX * $PORT_OFFSET)))

### Alias

# Setup
DOCKER_SETUP_RECONFIGURE_ALIAS=docker_${ID}_setup_reconfigure
DOCKER_SETUP_REMOVE_ENV_ALIAS=docker_${ID}_setup_remove_env

# Development
DOCKER_DEVELOPMENT_UNDEPLOY_ALIAS=docker_${ID}_development_undeploy
DOCKER_DEVELOPMENT_DEPLOY_ALIAS=docker_${ID}_development_deploy
DOCKER_DEVELOPMENT_REDEPLOY_ALIAS=docker_${ID}_development_redeploy

# Database
DOCKER_DATABASE_INIT_ALIAS=docker_${ID}_database_init
DOCKER_DATABASE_MIGRATE_ALIAS=docker_${ID}_database_migrate
DOCKER_DATABASE_CREATE_DUMP_ALIAS=docker_${ID}_database_create_dump
DOCKER_DATABASE_CREATE_DUMP_V_1_1_ALIAS=docker_${ID}_database_create_dump_v_1_1

### Commands

VAGRANT_SSH="${VAGRANT_SSH:-}"
SET_ALIAS="source <(ID=${ID} OMS_DB_NAME=${OMS_DB_NAME} OMS_DB_USER=${OMS_DB_USER} OMS_DB_PASSWORD=${OMS_DB_PASSWORD} OMS_DB_DUMP=${OMS_DB_DUMP} ${UNIX_PROJECT_PATH}/scripts/template_engine.sh ${UNIX_PROJECT_PATH}/templates/alias.template)"

# Setup
DOCKER_SETUP_RECONFIGURE="docker exec ${ID} bash /usr/local/bin/docker_reconfigure.sh --wsdl-host=${HOST_IOM} --wsdl-port=${FORWARD_PORT_IOM}"
DOCKER_SETUP_REMOVE_ENV="docker rm -f ${ID} && docker rm -f ${ID}_db && docker rm -f ${ID}_db_data"

# Development
DOCKER_DEVELOPMENT_UNDEPLOY="docker exec ${ID} bash /usr/local/bin/docker_undeploy.sh"
DOCKER_DEVELOPMENT_DEPLOY="docker exec ${ID} bash /usr/local/bin/docker_deploy.sh"
DOCKER_DEVELOPMENT_REDEPLOY="docker exec ${ID} bash /usr/local/bin/docker_redeploy.sh"

# Database
DOCKER_DATABASE_INIT="docker exec ${ID}_db bash -c 'cd /tmp/src/postgres/dumps && bash reset_test_data.sh -U ${OMS_DB_USER} -d ${OMS_DB_NAME} -f ${OMS_DB_DUMP} ${OMS_SKIP_BUSINESS_CONFIG} -c en_US.utf8 -n'"
DOCKER_DATABASE_MIGRATE="docker exec ${ID}_db bash -c 'cd /tmp/src/postgres/migrations && bash dbmigrate.sh -h localhost -U ${OMS_DB_USER} -p 5432 -d ${OMS_DB_NAME} -n"
DOCKER_DATABASE_CREATE_DUMP="docker exec ${ID}_db bash -c \\\"cd /tmp/src/postgres/dumps && pg_dump -O -b -U oms_user -h localhost -p 5432 -d oms_db -n admin -n oms -n customer -n omt -n product -n system -n testcases -n bizconf |sed 's/^REVOKE ALL ON SCHEMA/--REVOKE ALL ON SCHEMA/g' |sed 's/^GRANT ALL ON SCHEMA/--GRANT ALL ON SCHEMA/g' |sed 's/^SET idle_in_transaction_session_timeout/-- SET idle_in_transaction_session_timeout/g' |gzip > ${ID}-$(date '+%Y-%m-%d-%H-%M-%S').dmp.gz\\\""
DOCKER_DATABASE_CREATE_DUMP_V_1_1="docker exec ${ID}_db bash -c \\\"cd /tmp/src/postgres/dumps && pg_dump -O -b -U oms_user -h localhost -p 5432 -d oms_db -n admin -n oms -n customer -n omt -n product -n system -n testcases -n bizconf -n dwh |sed 's/^REVOKE ALL ON SCHEMA/--REVOKE ALL ON SCHEMA/g' |sed 's/^GRANT ALL ON SCHEMA/--GRANT ALL ON SCHEMA/g' |sed 's/^SET idle_in_transaction_session_timeout/-- SET idle_in_transaction_session_timeout/g' |gzip > ${ID}-$(date '+%Y-%m-%d-%H-%M-%S').dmp.gz\\\""
