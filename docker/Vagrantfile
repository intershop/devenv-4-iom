# -*- mode: ruby -*-
# vi: set ft=ruby

# Require modules
require 'json'
require 'yaml'

# global configuration for the docker host
DOCKER_HOST_NAME = "iomdev"
DOCKER_HOST_VAGRANTFILE = "../Vagrantfile"

VAGRANT_ROOT = File.dirname(File.expand_path(__FILE__))

PORT_OFFSET = 10

# Read environment details from either yml or json file

configuration_file = File.join(VAGRANT_ROOT, '../environments.yml')

if File.file?(configuration_file)
  environments = YAML.load_file(configuration_file)
  # print "'" + configuration_file + "' configuration will be used."
else
  configuration_file = File.join(VAGRANT_ROOT, '../environments.json')
  environments = JSON.parse(File.read(configuration_file))
  # print "'" + configuration_file + "' configuration will be used."
end

Vagrant.configure(2) do |config|

  environments.each.with_index(1) do |environment , index|

    # provide a private docker registry
    config.vm.define "#{environment['id']}", autostart: false do |container|

      container.vm.provider "docker" do |d|

        # configure the docker config
        d.image = "#{environment['docker_image']}"
        d.create_args = ["--privileged"]
        d.remains_running = true
        # [host port:container port]
        d.ports = [
          # OMT
          "#{8080 + (index * PORT_OFFSET)}:8080",
          # wildfly console
          "#{9990 + (index * PORT_OFFSET)}:9990",
          # debug port
          "#{8787 + (index * PORT_OFFSET)}:8787",
        ]

        volumes = [
          # configure the etc path
          "/tmp/#{environment['id']}/etc:/etc/opt/oms.standalone",

          # configure the log path
          "/tmp/#{environment['id']}/log:/var/opt/oms.standalone/log"

          # "/usr/local/bin:/usr/local/bin"
        ]

        # configure the app path
        if environment['oms_app']
          volumes.push("/tmp/#{environment['id']}/app:/opt/oms.standalone/application")
        end

        ### file synchronization
        d.volumes = volumes

        d.name = "#{environment['id']}"
        d.pull = true

        # configure a dedicated docker host
        d.vagrant_machine = "#{DOCKER_HOST_NAME}"
        d.vagrant_vagrantfile = "#{DOCKER_HOST_VAGRANTFILE}"
      end

      config.vm.post_up_message = "\n\nYour container '#{environment['id']}' requires a reconfiguration. \nLogin into your docker host and run following command:\ndocker exec #{environment['id']} bash /usr/local/bin/docker_reconfigure.sh\n\nVisit http://localhost:#{8080 + (index * PORT_OFFSET)}/omt for the OMT application! \nVisit http://localhost:#{9990 + (index * PORT_OFFSET)}/console for the wildfly console.\n\n"

    end
  end

  # provide a private docker registry
  config.vm.define "registry", autostart: false do |container|

    container.vm.provider "docker" do |d|

      # configure the docker config
      d.image = "registry"
      d.remains_running = true
      # [host port:container port]
      d.ports = ['5000:5000']
      d.name = 'registry'

      # configure a dedicated docker host
      d.vagrant_machine = "#{DOCKER_HOST_NAME}"
      d.vagrant_vagrantfile = "#{DOCKER_HOST_VAGRANTFILE}"
    end
  end

end
