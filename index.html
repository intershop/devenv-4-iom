<html>
  <head>
    <title>IOM Development Environment</title>

    <!--meta http-equiv="refresh" content="60"-->

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- google code-prettify -->
    <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>

    <!-- font awesome -->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

    <!-- https://github.com/daylerees/colour-schemes -->
    <style>

      body > .container {
        margin-top: 50px;
      }

      .alias-toggle {
        padding: 2px 3px;
      }

    </style>

  </head>
  <body>
    <!-- Fixed navbar -->
      <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#">devenv-4-iom</a>
          </div>
          <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">First steps <span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="#first-steps--overview">Overview</a></li>
                  <li><a href="#first-steps--config">Configuration</a></li>
                  <li><a href="#first-steps--create">Create IOM Cluster</a></li>
                  <li><a href="#first-steps--use">Access IOM GUI</a></li>
                  <li><a href="#first-steps--logs">View Access Logs</a></li>
                  <li><a href="#first-steps--sql">Execute SQL File</a><li>
                  <li><a href="#first-steps--delete">Delete IOM Cluster</a></li>
                </ul>
              </li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Configuration <span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="#configurations--create-config">Create a New Configuration</a></li>
                  <li><a href="#configurations--link-config">Link Configuration to <samp>devenv-cli.sh</samp></a></li>
                  <li><a href="#configurations--change-config">Change Configuration Values</a></li>
                  <li><a href="#configurations--reset-config">Reset Configuration Partially</a></li>
                  <li><a href="#configurations--parallel-instances">Running Different IOM Instances in Parallel</a></li>
                  <li><a href="#configurations--migrate-config">Migrate a Configuration After Update of <samp>devenv-4-iom</samp></a></li>
                  <li><a href="#configurations--delete-config">Delete a Configuration</a></li>
                </ul>
              </li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Operations <span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="#operations--create-cluster">Create Whole IOM cluster</a></li>
                  <li><a href="#operations--delete-cluster">Delete Whole IOM cluster</a></li>
                  <li><a href="#operations--create-namespace">Create Namespace</a></li>
                  <li><a href="#operations--delete-namespace">Delete Namespace</a></li>
                  <li><a href="#operations--create-mailserver">Create Mailserver</a></li>
                  <li><a href="#operations--delete-mailserver">Delete Mailserver</a></li>
                  <li><a href="#operations--create-storage">Create Local Docker Volume</a></li>
                  <li><a href="#operations--delete-storage">Delete Local Docker Volume</a></li>
                  <li><a href="#operations--create-postgres">Start postgres Database</a></li>
                  <li><a href="#operations--delete-postgres">Delete postgres Database</a></li>
                  <li><a href="#operations--create-iom">Create IOM</a></li>
                  <li><a href="#operations--delete-iom">Delete IOM</a></li>
                  <li><a href="#operations--info">Get Information About Components</a></li>
                </ul>
              </li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Development process <span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="#development--deployment-gui">Deployment Using the Wildfly Admin Console</a></li>
                  <li><a href="#development--deployment-cli">Deployment Using Scripts</a></li>
                  <li><a href="#development--apply-mail-templates">Roll Out Mail Templates</a></li>
                  <li><a href="#development--apply-xsl-templates">Roll Out XSL Templates</a></li>
                  <li><a href="#development--apply-sql-scripts">Apply SQL Scripts</a></li>
                  <li><a href="#development--apply-dbmigrate">Apply DBMigrate Scripts</a></li>
                  <li><a href="#development--apply-sql-config">Apply SQL Configuration Scripts</a></li>
                  <li><a href="#development--apply-json-config">Apply JSON Configuration Scripts</a></li>
                  <li><a href="#development--dump-load">Load Custom Dump</a></li>
                  <li><a href="#development--dump-create">Create Dump</a></li>
                  <li><a href="#development--access-emails">Access E-Mails</a></li>
                  <li><a href="#development--access-pdf">Access PDF Documents</a></li>
                  <li><a href="#development--testing">Testing</a></li>
                </ul>
              </li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Log Messages <span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="#log-messages--jq">jq - Command-Line JSON Processor</a></li>
                  <li><a href="#log-messages--devenv">Log Messages of devenv-cli.sh</a></li>
                  <li><a href="#log-messages--iom-containers">Log Messages of IOM Containers</a></li>
                  <li><a href="#log-messages--log-cmd">devenv-cli's 'log *' Commands</a></li>
                </ul>
              </li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Troubleshooting <span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="#troubleshooting--get-help">Get Help on <samp>devenv-cli.sh</samp></a></li>
                  <li><a href="#troubleshooting--error-search">IOM is not Working</a></li>
                  <li><a href="#troubleshooting--manual-cleanup">Manual Cleanup</a></li>
                  <li><a href="#troubleshooting--shared-drives">Shared Drives</a></li>
                  <li><a href="#troubleshooting--wrong-context">Wrong Kubernetes Context</a></li>
                </ul>
              </li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </nav>

      <div class="container">

        <h1>devenv-4-iom - IOM Development Environment</h1>

        <h2 id="first-steps">First Steps</h2>
        <h3 id="first-steps--overview">Overview</h3>
        <p>
          The section <a href="#first-steps">First Steps</a> is intended to guide you through all main parts of <samp>devenv-4-iom</samp> by very simple examples. You will learn how to:</p>
            <ul>
          <li>Set up an IOM cluster,</li>
          <li>Browse through the GUI of IOM,</li>
          <li>Take a look on access-log messages,</li>
          <li>Solve a very simple development task: Executing an SQL file</li>
          <li>Eventually destroy the IOM cluster again</li>
          </ul>
        <p>
          Once you are able to set up IOM with <samp>devenv-4-iom</samp> and have an insight into its main ideas, it should become easy for you to find out more by yourself and to solve the development tasks you need to solve.
        </p>
        <h3 id="first-steps--config">Configuration</h3>
        <p>
          <samp>devenv-4-iom</samp> uses a very simple concept to manage developer instances of IOM. One configuration file holds all the information required to run one instance of IOM. As first step, a new configuration file has to be created now. To do so, the script <samp>devenv-cli.sh</samp> has to be called with options <samp>get config</samp>. In order to get the following examples to work, you have to extend the <samp>PATH</samp> variable by the directory, containing <samp>devenv-cli.sh</samp>, or you can also call the script using its absolute path.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# extend PATH variable
# PATH_TO_DEVENV_CLI has to be replaced by the real value.
export PATH="${PATH_TO_DEVENV_CLI}:$PATH"

# create configuration file, filled with default values
devenv-cli.sh get config > config.properties
        </div></code></pre>

        <p>
          There is one value in config.properties, that has to be set manually: <samp>ID</samp>. Every instance of IOM, hence every configuration file, needs to have a unique value for <samp>ID</samp>. Once you have set the <samp>ID</samp> and started the according IOM, you must not change it anymore. Otherwise you will loose the ability to access/control the resources associated with the IOM installation. Now set the <samp>ID</samp> to <samp>first-steps</samp>.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# set ID in config.properties to "first-steps"
vi config.properties
        </div></code></pre>

        <p>
          The other values of the new configuration file are filled with default settings defined by <samp>devenv-4-iom</samp>. The most important settings are the <samp>*_IMAGE</samp> properties, since they define what will be executed by <samp>devenv-4-iom</samp>. By defining the images, you can control, for example, that a specific project, a standard IOM product without any customizations, an IOM product which is currently in development or even containers of the IOM product or project you have created yourself will run on your local computer.
        </p><p>
          The default settings use the pure IOM product. It is not necessary to change any of these settings for the first steps. The Docker registry used by default settings requires a login. Hence you have to log in to the registry. Additionally you should check if you are able to access the Docker images specified in the configuration file. To do so, try to pull the images manually in a shell.
        </p><p>
          Open the newly created config-file <samp>config.properties</samp> and copy the values of the <samp>*_IMAGE</samp> properties and use them to pull the Docker images manually, just as shown in the box below.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# login into Docker registry
docker login docker-iom.rnd.intershop.de

# pull images from registry
docker pull postgres:11
docker pull mailhog/mailhog
docker pull docker-iom.rnd.intershop.de/intershop/iom-dbaccount:1.1.0.0
docker pull docker-iom.rnd.intershop.de/intershop/iom-config:3.0.0.0
docker pull docker-iom.rnd.intershop.de/intershop/iom-app:3.0.0.0
        </div></code></pre>
        <p>
          Before using <samp>devenv-cli.sh</samp> to manage our IOM developer instance, we need to have a look at how configuration files are passed to the script. There are two different ways:
          <ol>
            <li>Set the configuration file as first command line parameter of <samp>devenv-cli.sh</samp>.</li>
            <li>Define the configuration file as value for the environment variable <samp>DEVENV4IOM_CONFIG</samp>.</li>
          </ol>
          For this guide, we will use the second variant. It is recommended to store the absolute name of the configuration file in <samp>DEVENV4IOM_CONFIG</samp>, otherwise <samp>devenv-cli.sh</samp> would find the file only if it is called in the same directory as the configuration file resides.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
export DEVENV4IOM_CONFIG="$(pwd)/config.properties"
        </div></code></pre>

        <h3 id="first-steps--create">Create IOM Cluster</h3>
        <p>
          For IOM to run in Kubernetes, several (sub-)systems are required:
          <ul>
            <li>A kubernetes namespace, to isolate different installations from each other</li>
            <li>A persistent storage to be used by the database</li>
            <li>A PostgreSQL database, which is using persistent storage</li>
            <li>A mail-server to receive mails sent by IOM. The mail-server used by <samp>devenv-4-iom</samp> allows you to access the received mails by a GUI and by a REST interface.</li>
            <li>The IOM sever itself</li>
          </ul>
          <samp>devenv-4-iom</samp> provides a very easy way to setup all these systems and make them work together. Just create the cluster by executing the following command:
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
devenv-cli.sh create cluster
        </div></code></pre>
        <p>
          The process of cluster creation will take some minutes (between 3 and 10, depending on your hardware). During this time we should take a look at the statuses of the (sub-)systems.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# get status of storage
devenv-cli.sh info storage

# get info about mail server
devenv-cli.sh info mailserver

# get info about Postgres server
devenv-cli.sh info postgres

# get info about IOM server
devenv-cli.sh info iom
        </div></code></pre>
        <p>
          Mail server and PostgreSQL server start very fast. The output of the according <samp>'info'</samp> commands contains a section 'Kubernetes', which shows the state. For these two systems, the state should be <samp>running</samp> even shortly after creating the cluster. The box below shows an example output:
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
devenv-cli.sh info postgres
...
--------------------------------------------------------------------------------
Kubernetes:
===========
namespace:                  21700snapshot
KEEP_DATABASE_DATA:         true
NAME       READY   STATUS    RESTARTS   AGE
postgres   1/1     Running   0          8s
--------------------------------------------------------------------------------
...
        </div></code></pre>
        <p>
          The start of IOM will take much longer. You can use the <samp>'info iom'</samp> command, to check the state periodically. After some minutes IOM should be in running state too. The according output should look like this:
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
devenv-cli.sh info iom
...
--------------------------------------------------------------------------------
Kubernetes:
===========
namespace:                  21700snapshot
NAME                   READY   STATUS    RESTARTS   AGE
iom-6c587ddd87-d7qb2   1/1     Running   0          5m5s
--------------------------------------------------------------------------------
...
        </div></code></pre>

        <h3 id="first-steps--use">Access IOM GUI</h3>
        <p>
          Now IOM is running and we can access its GUI. The <samp>'info iom'</samp> command provides the according information about the URL you have to use. The following box shows an example:
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
devenv-cli.sh info iom
...
--------------------------------------------------------------------------------
Links:
======
OMT:                        http://computername.local:8080/omt
DBDoc:                      http://computername.local:8080/dbdoc/
Wildfly (admin:admin):      http://computername.local:9990/console
--------------------------------------------------------------------------------
...
        </div></code></pre>
        <p>
          Just copy the <samp>OMT</samp> link into your browser and open the page. You should now see the login screen. The combination of <samp>admin:!InterShop00!</samp> should give you access to IOM.
        </p>

        <h3 id="first-steps--logs">View Access Logs</h3>
        <p>
          IOM is now running and we are able to use it in the browser. It is time to learn how to access some log messages. Since we can browse the IOM, the access-log message will give us a good example. The following command prints access-log entries and also waits for new entries.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# press ^C to stop printing logs
devenv-cli.sh log access all -f
...
{
  "eventSource": "web-access",
  "hostName": "default-host",
  "tenant": "Intershop",
  "environment": "2.17.0.0-SNAPSHOT",
  "logHost": "iom-6c587ddd87-d7qb2",
  "logVersion": "1.0",
  "appVersion": "2.17.0.0-SNAPSHOT@1234",
  "appName": "iom-app",
  "logType": "access",
  "configName": "ci",
  "bytesSent": 33586,
  "dateTime": "2019-12-17T14:12:36153Z",
  "localIp": "10.1.1.210",
  "localPort": 8080,
  "remoteHost": "192.168.65.3",
  "remoteUser": null,
  "requestHeaderReferer": "http://computername.local:8080/omt/app/order/landingpage",
  "requestHeaderUser-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.4 Safari/605.1.15",
  "requestHeaderHost": "computername.local:8080",
  "requestHeaderCookie": "OMS_IDENTITY=eyJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJPTVQiLCJleHAiOjE1NzY2NzgzNDksImlhdCI6MTU3NjU5MTk0OSwic3ViIjoiQXV0aGVudGljYXRpb24iLCJ1c2VyIjoiYWRtaW4ifQ.c5XuyKZM1FbrwRRGTg4CqaXog3WN6K-kuSTYSp6WEio; SessionKey=11a11a64-9ee9-44cc-bd4d-7ffbb1e12fac; JSESSIONID=k_AxMo_ElpYnjaTTLAkOeFoF3LF_W6VW67PpYcG1.iom-6c587ddd87-d7qb2; org.springframework.web.servlet.i18n.CookieLocaleResolver.LOCALE=en",
  "requestLine": "GET /omt/WEB-INF/views/widgets/shortOrderSearchContainer.jsp?_=1576591952608 HTTP/1.1",
  "requestProtocol": "HTTP/1.1",
  "requestScheme": "http",
  "responseCode": 200,
  "responseHeaderContent-Type": "text/html;charset=utf-8",
  "responseHeaderSet-Cookie": null,
  "responseTime": 3420
}
{
  "eventSource": "web-access",
  "hostName": "default-host",
  "tenant": "Intershop",
  "environment": "2.17.0.0-SNAPSHOT",
  "logHost": "iom-6c587ddd87-d7qb2",
  "logVersion": "1.0",
  "appVersion": "2.17.0.0-SNAPSHOT@1234",
  "appName": "iom-app",
  "logType": "access",
  "configName": "ci",
  "bytesSent": 472,
  "dateTime": "2019-12-17T14:12:41026Z",
  "localIp": "10.1.1.210",
  "localPort": 8080,
  "remoteHost": "10.1.0.1",
  "remoteUser": null,
  "requestHeaderReferer": null,
  "requestHeaderUser-Agent": "kube-probe/1.14",
  "requestHeaderHost": "10.1.1.210:8080",
  "requestHeaderCookie": null,
  "requestLine": "GET /monitoring/services/health/status HTTP/1.1",
  "requestProtocol": "HTTP/1.1",
  "requestScheme": "http",
  "responseCode": 200,
  "responseHeaderContent-Type": "application/json",
  "responseHeaderSet-Cookie": null,
  "responseTime": 2
}
...
        </div></code></pre>

        <h3 id="first-steps--sql">Execute SQL File</h3>
        <p>
          The execution of an SQL file is a very simple example of a development task. To execute this task, we have to create an SQL file first. Therefore just create a file with the extension <samp>.sql</samp> and copy the following content into it:
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
select * from "CountryDefDO";
        </div></code></pre>
        <P>
          You have to make sure, that the file can be shared with Docker Desktop. Just check the settings of Docker Desktop. Go to <samp>Docker Desktop > Preferences > File Sharing</samp> and check if the file is located in a shared directory. If not, move it to a shared directory or change the preferences (but this requires a restart of Docker Desktop). For more information about sharing with Docker Desktop, please have a look at <a href="https://blogs.msdn.microsoft.com/stevelasker/2016/06/14/configuring-docker-for-windows-volumes/" target="_blank">Configuring Docker for Windows Shared Drives / Volume Mounting with AD</a> in the Microsoft documentation.
        </p><p>
          The following box shows an example where the file is named <samp>/home/user/test.sql</samp>. If you have <samp>jq</samp> installed, you can pipe the output through <samp>jq</samp> to get pretty-printed messages.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
devenv-cli.sh apply sql-script /home/user/test.sql
{ "tenant":"Intershop", "environment":"devenv4iom", "logHost":"computername.local", "logVersion":"1.0", "appName":"devenv4iom", "appVersion":"1.0.0.0-SNAPSHOT", "logType":"script", "timestamp":"2019-12-17T14:42:23Z", "level":"INFO", "message":"apply-sql-scripts: job successfully started", "processName":"devenv-cli.sh", "additionalInfo":"job.batch/apply-sql-job created", "configName":"ci" }
{"tenant":"Intershop","environment":"2.17.0.0-SNAPSHOT","logHost":"apply-sql-job-kqcnh","logVersion":"1.0","appName":"iom-config","appVersion":"2.17.0.0-SNAPSHOT@1234","logType":"script","timestamp":"2019-12-17T14:42:24+00:00","level":"INFO","processName":"apply_sql.sh","message":"Properties","configName":"ci","additionalInfo":"--src=/tmp/sql-dir-volume/test.sql\nOMS_DB_HOST=postgres-service\nOMS_DB_PORT=5432\nOMS_DB_NAME=oms_db\nOMS_DB_USER=oms_user\nOMS_DB_PASS=oms_pw\nOMS_USER_CONNECTION_SUFFIX=\nOMS_LOGLEVEL_SCRIPTS=INFO\nTENANT=Intershop\nENVIRONMENT=2.17.0.0-SNAPSHOT"}
{"tenant":"Intershop","environment":"2.17.0.0-SNAPSHOT","logHost":"apply-sql-job-kqcnh","logVersion":"1.0","appName":"iom-config","appVersion":"2.17.0.0-SNAPSHOT@1234","logType":"script","timestamp":"2019-12-17T14:42:24+00:00","level":"INFO","processName":"apply_sql.sh","message":"processing file '/tmp/sql-dir-volume/test.sql'","configName":"ci"}
{"tenant":"Intershop","environment":"2.17.0.0-SNAPSHOT","logHost":"apply-sql-job-kqcnh","logVersion":"1.0","appName":"iom-config","appVersion":"2.17.0.0-SNAPSHOT@1234","logType":"script","timestamp":"2019-12-17T14:42:24+00:00","level":"INFO","processName":"apply_sql.sh","message":"success","configName":"ci"}
{ "tenant":"Intershop", "environment":"devenv4iom", "logHost":"computername.local", "logVersion":"1.0", "appName":"devenv4iom", "appVersion":"1.0.0.0-SNAPSHOT", "logType":"script", "timestamp":"2019-12-17T14:42:29Z", "level":"INFO", "message":"apply-sql-scripts: successfully deleted job", "processName":"devenv-cli.sh", "additionalInfo":"job.batch \"apply-sql-job\" deleted", "configName":"ci" }
        </div></code></pre>
        <p>
          As you can see, the method shown above is not intended to show you the results of your <samp>select</samp> statement. For such purposes the interactive usage of <samp>psql</samp> to communicate with the PostgreSQL server is the better solution. Just use the command <samp>'info postgres'</samp> to get the according command line.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
devenv-cli.sh info postgres
...
Usefull commands:
=================
Login into Pod:             kubectl exec --namespace firststeps postgres -it bash
psql into root-db:          kubectl exec --namespace firststeps postgres -it -- bash -c "PGUSER=postgres PGDATABASE=postgres psql"
psql into IOM-db:           kubectl exec --namespace firststeps postgres -it -- bash -c "PGUSER=oms_user PGDATABASE=oms_db psql"
...

# now use the command for "psql into IOM-db" and
# enter the select statement interactively
kubectl exec --namespace firststeps postgres -it -- bash -c "PGUSER=oms_user PGDATABASE=oms_db psql"
psql (11.8 (Debian 11.8-1.pgdg90+1))
Type "help" for help.

oms_db=> select * from "CountryDefDO";
 id | currency |       currencyName        | currencySymbol | isoCode2 | isoCode3 | isoNumeric |                 name
----+----------+---------------------------+----------------+----------+----------+------------+--------------------------------------
  1 | JMD      | Jamaica Dollar            | J$             | JM       | JAM      | 388        | Jamaica
  2 | EUR      | Euro                      | &euro;              | DE       | DEU      | 276        | Germany
  3 | EUR      | Euro                      | &euro;              | AT       | AUT      | 040        | Austria
  4 | EUR      | Euro                      | &euro;              | NL       | NLD      | 528        | Netherlands
  5 | CHF      | Schweizer Franken         | SFr            | CH       | CHE      | 756        | Switzerland
...
        </div></code></pre>

        <h3 id="first-steps--delete">Delete IOM Cluster</h3>
        <p>
          Now it is time to clean up the environment. To do so, we have to execute the following two steps:
          <ul>
            <li>Delete IOM cluster</li>
            <li>Delete persistent storage</li>
          </ul>
          Unlike the cluster creation step, which included the creation of the persistent storage as well, the cluster deletion step does not affect the persistent storage. This way you could simply create a new cluster which uses the old database data. To delete the persistent storage, we have to do it explicitely by executing the according command.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
devenv-cli.sh delete cluster
devenv-cli.sh delete storage
        </div></code></pre>
        <p>
          After deleting all resources belonging to our IOM developer instance, it is also save to delete the configuration file. Do not forget to unset DEVENV4IOM_CONFIG too!
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
rm config.properties
export DEVENV4IOM_CONFIG=
        </div></code></pre>
        <p>
          We have used <samp>devenv-cli.sh</samp> a lot. If you want to explore all features of this program, just call it with <samp>-h</samp> as argument.
        </p>

        <h2 id="configurations">Configuration</h2>

        <h3 id="configurations--create-config">Create an New Configuration</h3>
        <p>
          <samp>devenv-4-iom</samp> uses a very simple concept to manage developer instances of IOM. One configuration file holds all the information required to run one instance of IOM. Along the many configuration values needed to control the behavior of IOM, there is one property which is required to mark Kubernetes and Docker resources as being associated with a certain configuration. This property is the <samp>ID</samp>. Each configuration has to have its own unique <samp>ID</samp>. Hence, the creation of a new configuration file consists of these steps:
          <ol>
            <li>Create a new configuration file based on the template provided by <samp>devenv-4-iom</samp>. Make sure that there is currently no other configuration file used.</li>
            <li>Set <samp>ID</samp> in the newly created configuration file to a unique value.</li>
            <li>Adapt all other entries in the configuration file according your needs.</li>
          </ol>
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# Make sure, no other configuration file is currently used.
export DEVENV4IOM_CONFIG=

# Create a new configuration file containing default values only.
devenv-cli.sh get config > config.properties

# Set ID to a unique value and adapt other values according your needs.
vi config.properties
        </div></code></pre>

        <h3 id="configurations--link-config">Link Configuration to <samp>devenv-cli.sh</samp></h3>
        <p>
          <samp>devenv-cli.sh</samp> is used to control your IOM developer instances. Therefore the configuration has to be passed on each call of this script. There are two different ways to link <samp>devenv-cli.sh</samp> to a certain configuration:
          <ol>
            <li>The configuration file can be passed as first parameter of the command line.</li>
            <li>The configuration file can be set in the environment variable <samp>DEVENV4IOM_CONFIG</samp></li>
          </ol>
          In case both methods are used at once, the configuration file passed on the command line has precedence.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# Provide the absolute name of configuration file in DEVENV4IOM_CONFIG
export DEVENV4IOM_CONFIG="$(pwd)/config.properties"

# devenv-cli.sh will now use the config defined by the environment variable
devenv-cli.sh info iom

# Or set configuration file as first parameter at the command line
devenv-cli.sh another-config.properties info iom
        </div></code></pre>

        <h3 id="configurations--change-config">Change Configuration Values</h3>
        <p>
          Changing a value in the configuration file does not automatically change the according developer instance of IOM. The only process guaranteeing that changes are applied is the complete recreation of the IOM installation.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# Change configuration file
vi config.properties

# Delete the whole IOM cluster
devenv-cli.sh delete iom

# Create the IOM cluster
devenv-cli.sh create iom
        </div></code></pre>

        <h3 id="configurations--reset-config">Reset Configuration Partially</h3>
        <p>
          If you want to reset the whole configuration, simply create a new one and set the ID inside the properties file to the old value (see <a href="#configurations--create-config">Create a New Configuration</a>).
        </p><p>
          To reset only parts of the configuration, just delete the according entries from your configuration file. Now create a new configuration file, but make sure the old conifguration is used during this process. In this case, only the missing/empty properties of the old configuration are filled with default values in the new configuration file.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# Remove entries from config file, that should be filled with default values.
vi config.properties

# Create a new configuration file based on the old one.
devenv-cli.sh config.properties get config > new-config.properties

# Check the reseted entries and change them according to your requirements.
        </div></code></pre>


        <h3 id="configurations--parallel-instances">Parallel Instances of devenv-4-iom Environments</h3>
        <p>
          Running different IOM installations within devenv-4-iom is no problem as long as they are not running simultaneously. Just run <samp>'delete cluster'</samp> on one installation before running <samp>'create cluster'</samp> on another.
        </p><p>
          Different IOM installations are perfectly isolated by different namespaces on Kubernetes level. Precondition is the usage of unique IDs in configurations (see <a href="#configurations--create-config">Create a new configuration</a>). However, when it comes to the operating system level of your host machine, the ports required to access the IOM installation from the outside collide.
        </p><p>
          Devenv-4-iom provides a simple mechanism to avoid port collisions. The configuration variable <samp>INDEX</samp> controls the port usage when providing services at OS level. Just make sure that every IOM configuration uses a different value for <samp>INDEX</samp>. After each change of <samp>INDEX</samp> you have to delete and create the cluster (see <a href="#configurations--change-config">Change configuration values</a>).
        </p>

        <h3 id="configurations--migrate-config">Migrate a Configuration After Update of <samp>devenv-4-iom</samp></h3>
        <p>
          After updating <samp>devenv-4-iom</samp>, the content of the current configuration file has to be updated too. The new version of <samp>devenv-4-iom</samp> might bring a new template for configuration files, which may contain new properties or improved comments. You have to create a new configuration file based on this template, which is filled with your current configuration. To do so, just create a new configuration file, but make sure your current configuration is used during this process (see <a href="#configurations--reset-config">Reset Configuration Partially</a>).
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# Create a new configuration file based on the old one
devenv-cli.sh config.properties get config > migrated-config.properties

# Check the migrated configuration file for new properties and change them according to your requirements.
vi migrated-config.properties
        </div></code></pre>

        <h3 id="configurations--delete-config">Delete a Configuration</h3>
        <p>
          Before deleting a configuration file, you must ensure that all associated Kubernetes and Docker resources are deleted as well. You will not be able to delete them using <samp>devenv-cli.sh</samp> afterwards. Executing <samp>'delete cluster'</samp> and <samp>'delete storage'</samp> will remove all resources assigned to a configuration. Addtionally, it is recommended to delete unused Docker images too.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# Delete IOM cluster
devenv-cli.sh delete cluster

# Delete storage
devenv-cli.sh delete storage

# Now the configuration file can be deleted
rm config.properties

# Do not forget to unset the environment variable pointing to the configuration file
export DEVENV4IOM_CONFIG=

# Clean up unused Docker images (cleans up all unused images, not only the ones related to the current configuration)
docker system prune -a -f
        </div></code></pre>
        <p>
          If you have accidentally removed a configuration file before deleting the according Kubernetes and Docker resources, you have to cleanup these resources manually. Section <a href="#troubleshooting--manual-cleanup">"Manual Cleanup"</a> describes this process in detail.
        </p>

        <!--
            ############# Operational commands ###############
          -->

        <h2 id="setup">Operations</h2>

        <h3 id="operations--create-cluster">Create Whole IOM Cluster</h3>

        <p>The creation of a whole IOM cluster consists of several steps. These are:</p>
        <ol>
          <li><a href="#operations--create-storage">Create local Docker volume</a> (not required if <samp>KEEP_DATABASE_DATA</samp> is set to <samp>false</samp>)</li>
          <li><a href="#operations--create-namespace">Create namespace</a></li>
          <li><a href="#operations--create-mailserver">Create mailserver</a></li>
          <li><a href="#operations--create-postgres">Create postgres database</a> (not required if an external database is used, which is the case if <samp>PGHOST</samp> is set)</li>
          <li><a href="#operations--create-iom">Create IOM</a></li>
        </ol>
        <p>
          The command line client provides all these commands separately, but it also provides the shortcut <samp>'create cluster'</samp>, which does all these steps at once.
        </p>
        <p>
          Depending on the Docker registry you are using, it might be required to log in to the registry before you are able to create IOM as part of the cluster. If the Docker registry needs you to be logged in, just log in to it first.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# Optional: only if required by registry. You have to adapt this command to the
# registry used by *_IMAGE variables of your current configuration.
docker login docker-iom.rnd.intershop.de

# Now create the cluster
devenv-cli.sh create cluster
        </div></code></pre>

        <h3 id="operations--delete-cluster">Delete Whole IOM Cluster</h3>

        <p>Removing the whole IOM development environment consists of several steps. These are:</p>
        <ol>
          <li><a href="#operations--delete-iom">Delete IOM</a></li>
          <li><a href="#operations--delete-postgres">Delete postgres database</a> (not required, if an external database is used, which is the case if <samp>PGHOST</samp> is set)</li>
          <li><a href="#operations--delete-mailserver">Delete mailserver</a></li>
          <li><a href="#operations--delete-namespace">Delete namespace</a></li>
        </ol>
        <p>
          All these steps are provided as single commands by devenv-4-iom's command line client. The command line client also provides the shortcut <samp>'delete cluster'</samp>, which performs all these operations at once.
        </p><p>
          Please note that persistent storage will never be deleted by the <samp>'delete cluster'</samp> command.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
devenv-cli.sh delete cluster
        </div></code></pre>

        <h3 id="operations--create-namespace">Create Namespace</h3>
        <p>Namespace is required to isolate the devenv-4-iom from other resources and from resources of other configurations. The following command creates a namespace based on the ID you have specified in your properties.</p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
devenv-cli.sh create namespace
        </div></code></pre>

        <h3 id="operations--delete-namespace">Delete Namespace</h3>
        <p>The following command deletes the namespace and all resouces assigned to this namespace.</p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
devenv-cli.sh delete namespace
        </div></code></pre>

        <h3 id="operations--create-mailserver">Create Mail Server</h3>
        <p>The following command creates a mail server which is used to receive mails from IOM.</p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
devenv-cli.sh create mailserver
        </div></code></pre>

        <h3 id="operations--delete-mailserver">Delete Mail Server</h3>
        <p>The following command deletes the mail server.</p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
devenv-cli.sh delete mailserver
        </div></code></pre>

        <h3 id="operations--create-storage">Create Local Docker Volume</h3>
        <p>The following command creates a local Docker volume to be used to keep database data. This command is only effective if <samp>KEEP_DATABASE_DATA</samp> is set to <samp>true</samp></p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
devenv-cli.sh create storage
        </div></code></pre>

        <h3 id="operations--delete-storage">Delete Local Docker Volume</h3>
        <div class="alert alert-warning" role="alert">
          <strong>Note:</strong>
          <p>To remove the database data, you just have to remove the persistent database data volume with the following command. This command is only effective if a local Docker volume was created before (<samp>KEEP_DATABASE_DATA</samp> is set to <samp>true</samp>)</p><br>
          <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
devenv-cli.sh delete storage
          </div></code></pre>
        </div>

        <h3 id="operations--create-postgres">Create Postgres Database</h3>
        <p>The following command creates the Postgres database. This command is only effective if an internal database server is used (when <samp>PGHOST</samp> is not set).</p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
devenv-cli.sh create postgres
        </div></code></pre>

        <h3 id="operations--delete-postgres">Delete Postgres Database</h3>
        <p>The following command deletes the Postgres database. This command is only effective if an internal database was created before (when <samp>PGHOST</samp> is not set)</p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
devenv-cli.sh delete postgres
        </div></code></pre>

        <h3 id="operations--create-iom">Create IOM</h3>
        <p>
          The following command creates the IOM application server.
        </p><p>
          Depending on the Docker registry you are using, it might be required to log in at the registry before being able to create IOM as part of the cluster. If the Docker registry needs you to be logged in, just log in to it first.
        </p>

        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# Optional: only if required by the registry. You have to adapt this command to the
# registry used by *_IMAGE variables of your current configuration.
docker login docker-iom.rnd.intershop.de

# now create IOM
devenv-cli.sh create iom
        </div></code></pre>

        <h3 id="operations--delete-iom">Delete IOM</h3>
        <p>The following command deletes the IOM application server.</p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
devenv-cli.sh delete iom
        </div></code></pre>

        <h3 id="operations--info">Get Information About Components</h3>
        <p>
          Each component (IOM, Postgres, mail server, storage) has a lot of information to provide, e.g.:
        </p>
        <ul>
          <li>Links to access services</li>
          <li>Public ports</li>
          <li>Configuration settings</li>
          <li>Useful commands, etc.</li>
        </ul>
        <p>
          The command line client of devenv-4-iom provides a very simple interface to get these information:
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# Get information about IOM
devenv-cli.sh info iom

# Get information about mail server
devenv-cli.sh info mailserver

# Get information about PostgreSQL
devenv-cli.sh info postgres

# Get information about storage
devenv-cli.sh info storage
        </div></code></pre>

        <!--
            ############# development process ###############
          -->

        <h2 id="development">Development Process</h2>

        <h3 id="development--deployment-gui">Deployment of Custom Built Artifacts Using the Wildfly Admin Console</h3>
        <p>
          Using the <samp>Wildfly Admin Console</samp> is the easiest way to add or update deployments. The deployment process is simply triggered by drag & drop.
        </p><p>
          Unlike described in <a href="#development--deployment-cli">Deployment of custom built artifacts using CLI</a>, deployments added/updated this way, will not survive a restart of the IOM pod.
        </p>
        <p>
          The <samp>Wildfly Admin Console</samp> has to be opened in a web browser. The according URL can be found in the output of the <samp>'info iom'</samp> command.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# Get information about IOM
devenv-cli.sh info iom
...
--------------------------------------------------------------------------------
Links:
======
OMT:                        http://computername.local:8080/omt/
Online help:                http://computername.local:8080/omt-help/
DBDoc:                      http://computername.local:8080/dbdoc/
Wildfly (admin:admin):      http://computername.local:9990/console/
--------------------------------------------------------------------------------
...

# Copy the 'Wildfly' link to your web browser.
        </div></code></pre>

        <h3 id="development--deployment-cli">Deployment of Custom Built Artifacts Using CLI</h3>
        <p>
          To deploy custom built artifacts using the command line interface, you have to:
          <ul>
            <li>Set the variable <samp>CUSTOM_APPS_DIR</samp> in your configuration file and make sure that the <a href="https://blogs.msdn.microsoft.com/stevelasker/2016/06/14/configuring-docker-for-windows-volumes/" target="_blank">directory is shared in Docker Desktop</a>.</li>
            <li>After changing <samp>CUSTOM_APPS_DIR</samp>, the IOM application server needs to be restarted:</li>
            <ol>
              <li><a href="#operations--delete-iom">Delete IOM</a></li>
              <li><a href="#operations--create-iom">Create IOM</a></li>
            </ol>
          </ul>
          Once you have configured your developer VM this way, your custom built artifacts are deployed right at the start of IOM. To update/add deployments in a running developer VM, you have the following options:
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# Redeploy OMT selectively by adding one more parameter: A regular-expression to select the artifact to be redeployed
devenv-cli.sh apply deployment omt

# Redeploy all
devenv-cli.sh apply deployment
        </div></code></pre>
        <p>
          Of course you can combine both methods of deploying custom built artifacts to get the best out of both methods. If you set <samp>CUSTOM_APPS_DIR</samp> and make sure that the according directory contains your custom built artifacts, your developer VM will always use these artifacts, even right after IOM starts. Additionally you can use the <samp>Wildfly Admin Console</samp> to update/add deployments during runtime.
        </p>

        <h3 id="development--apply-mail-templates">Roll Out Custom Mail Templates</h3>
        <p>
          To roll out custom mail templates in a running developer VM, you have to:
          <ul>
            <li>Set variable <samp>CUSTOM_TEMPLATES_DIR</samp> in your configuration file and make sure that the <a href="https://blogs.msdn.microsoft.com/stevelasker/2016/06/14/configuring-docker-for-windows-volumes/" target="_blank">directory is shared in Docker Desktop</a>.</li>
            <li>After changing <samp>CUSTOM_TEMPLATES_DIR</samp>, the IOM application server must restarted:</li>
            <ol>
              <li><a href="#operations--delete-iom">Delete IOM</a></li>
              <li><a href="#operations--create-iom">Create IOM</a></li>
            </ol>
          </ul>
          Once you have configured your developer VM this way, you can apply custom mail templates by using the following command:
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
devenv-cli.sh apply mail-templates
        </div></code></pre>
        <p>
          If <samp>CUSTOM_TEMPLATES_DIR</samp> is configured, the templates are also copied when starting IOM.
        </p>

        <h3 id="development--apply-xsl-templates">Roll Out Custom XSL Templates</h3>
        <p>
          To roll out custom XSL templates in a running developer VM, you have to:
          <ul>
            <li>Set the variable <samp>CUSTOM_XSLT_DIR</samp> in your configuration file and make sure that the <a href="https://blogs.msdn.microsoft.com/stevelasker/2016/06/14/configuring-docker-for-windows-volumes/" target="_blank">directory is shared in Docker Desktop</a>.</li>
            <li>After changing <samp>CUSTOM_XSLT_DIR</samp>, the IOM application server has to be restarted:</li>
             <ol>
              <li><a href="#operations--delete-iom">Delete IOM</a></li>
              <li><a href="#operations--create-iom">Create IOM</a></li>
             </ol>
          </ul>
          Once you have configured your developer VM this way, you can apply custom XSL templates by using the following command:
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
devenv-cli.sh apply xsl-templates
        </div></code></pre>
        <p>
          If <samp>CUSTOM_XSLT_DIR</samp> is configured, the templates are also copied when starting IOM.
        </p>

        <h3 id="development--apply-sql-scripts">Apply SQL Scripts</h3>
        <p>
          The docker image defined by <samp>IOM_CONFIG_IMAGE</samp> contains all the necessary tools to apply SQL scripts to the IOM database. Devenv-4-iom enables you to use these tools as easily as possible. Therefore it provides a Kubernetes job (<samp>apply-sql-job</samp>) that applies SQL file(s) to the IOM database. Creation and deletion of job and access to logs is provided by the command <samp>'apply sql-scripts'</samp> of the command line interface.
        </p><p>
          There are two different modes that can be used:
          <ul>
            <li>If a directory is passed to the job, all SQL files found in this directory are processed in numerical order, starting with the smallest one. Sub-directories are not scanned for SQL files.</li>
            <li>If a file is passed to the job, only this file will be executed.</li>
          </ul>
          The information about the SQL file or directory is passed as third parameter to the command line client. The box below shows an example that executes all SQL scripts found in <samp>oms.tests/tc_stored_procedures</samp> (of course, the directory has to exist in your current working directory).
        </p><p>
          The logs are printed in JSON format. Verbosity can be controlled by the configuration variable <samp>OMS_LOGLEVEL_SCRIPTS</samp>.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# Adapt third paramater according your needs
devenv-cli.sh apply sql-scripts oms.tests/tc_stored_procedures
        </div></code></pre>

        <h3 id="development--apply-dbmigrate">Apply DBMigrate Scripts</h3>
        <p>
          To develop and test a single or a couple of SQL scripts (which can be migration scripts too), the developer task <em><a href="#development--apply-sql-scripts">Apply SQL Scripts</a></em> is the first choice. However, at some point of development, the DBMigrate process as a whole has to be tested too. The DBMigrate process is somewhat more complex than simply applying SQL scripts from a directory. It first loads stored procedures from the <samp>stored_procedures</samp> directory and then it applies the migrations scripts found in the <samp>migrations</samp> directory. The order of execution is controlled by the names of sub-directories within <samp>migrations</samp> and the naming of the migration scripts itself (numerically sorted, smallest first).
        </p><p>
          The <samp>IOM_CONFIG_IMAGE</samp> contains a shell script that applies the migration scripts supplied with the Docker image. The developer task <em><a href="#development--apply-dbmigrate">Apply DBMigrate scripts</a></em> enables you to use this DBMigrate script together with the migration scripts located at <samp>CUSTOM_DBMIGRATE_DIR</samp>. Hence, if you want to roll out custom DBMigrate scripts, you have to:
          <ul>
            <li>Set the variable <samp>CUSTOM_DBMIGRATE_DIR</samp> in your configuration file and make sure that the <a href="https://blogs.msdn.microsoft.com/stevelasker/2016/06/14/configuring-docker-for-windows-volumes/" target="_blank">directory is shared in Docker Desktop</a>.</li>
          </ul>
        </p><p>
          You can and should have an eye on the logs created by the migration process. These logs are printed in JSON format. Verbosity can be controlled by the configuration variable <samp>OMS_LOGLEVEL_SCRIPTS</samp>.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
devenv-cli.sh apply dbmigrate
        </div></code></pre>
        <p>
          If <samp>CUSTOM_DBMIGRATE_DIR</samp> is configured, the custom DBMigrate scripts are also applied when starting IOM.
        </p>

        <h3 id="development--apply-sql-config">Apply SQL Configuration Scripts</h3>
        <p>
          Scripts for SQL configuration are simple SQL scripts that can be easily developed and tested with the help of the developer task <a href="#development--apply-sql-scripts">Apply sql scripts</a>. However, SQL configuration in a CaaS project context is more complex. E.g. the scripts are executed depending on the currently activated environment. To be able to test SQL configuration scripts exactly in the same context as in a real IOM installation, the developer task <a href="#development--apply-sql-config">Apply SQL Configuration Scripts</a> is provided.
        </p><p>
          To be able to roll out complete SQL configurations, you have to:
          <ul>
            <li>Set the variable <samp>CUSTOM_SQLCONF_DIR</samp> in your configuration file and make sure that the <a href="https://blogs.msdn.microsoft.com/stevelasker/2016/06/14/configuring-docker-for-windows-volumes/" target="_blank">directory is shared in Docker Desktop</a>.</li>
            <li>Set the variable <samp>CAAS_ENV_NAME</samp> in your configuration file to the environment you want to test.</li>
          </ul>
        </p><p>
          You should have an eye on the logs created by the configuration process. These logs are printed in JSON format. Verbosity can be controlled by the configuration variable <samp>OMS_LOGLEVEL_SCRIPTS</samp>.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
devenv-cli.sh apply sql-config
        </div></code></pre>
        <p>
          If <samp>CUSTOM_SQLCONFIG_DIR</samp> is configured, the custom SQL configuration is also applied when starting IOM.
        </p>

        <h3 id="development--apply-json-config">Apply JSON Configuration Scripts</h3>
        <p>
          JSON configuration of IOM is not publicly available. There is no task to support the development of single JSON configuration scripts. Additionally, the current implementation of JSON configuration does not use the concept of environments (configuration variable <samp>CAAS_ENV_NAME</samp>). The current developer task <a href="#development--apply-json-config">Apply JSON Configuration Scripts</a> enables you to apply complete JSON configurations exactly in the same context as in a real IOM installation.
        </p><p>
          To roll out JSON configurations, you have to:
          <ul>
            <li>Set the variable <samp>CUSTOM_JSONCONF_DIR</samp> in your configuration file and make sure that the <a href="https://blogs.msdn.microsoft.com/stevelasker/2016/06/14/configuring-docker-for-windows-volumes/" target="_blank">directory is shared in Docker Desktop</a>.</li>
          </ul>
        </p><p>
          You should have an eye on the logs created by the configuration process. These logs are printed in JSON format. Verbosity can be controlled by the configuration variable <samp>OMS_LOGLEVEL_SCRIPTS</samp>.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
devenv-cli.sh apply json-config
        </div></code></pre>
        <p>
          If <samp>CUSTOM_JSONCONFIG_DIR</samp> is configured, the custom JSON configuration is also applied when starting IOM.
        </p>

        <h3 id="development--dump-load">Load Custom Dump</h3>
        <p>
          When starting IOM and the conneted database is empty, the config container loads the initial dump. Devenv-4-iom allows you to load a custom dump during this process. This custom dump will be treated exactly as any other dump which is part of the docker image. If you want to load a custom dump, you have to:
          <ul>
            <li>Set the variable <samp>CUSTOM_DUMPS_DIR</samp> in your configuration file and make sure that the <a href="https://blogs.msdn.microsoft.com/stevelasker/2016/06/14/configuring-docker-for-windows-volumes/" target="_blank">directory is shared in Docker Desktop</a>. The dump you want to load has to be located within this directory. To be recognized as a dump, it has to have the extension <samp>.sql.gz</samp>. If the directory contains more than one dump file, the script of the configuration container selects the one with the numerically largest name. You can check this with the following command: <samp>ls *.sql.gz | sort -nr | head -n 1</samp></li>
            <li>The custom dump can only be loaded if the database is empty. The <samp>'dump load'</samp> command of the command line client executes all the necessary steps to restart IOM with an empty database, but only if no external database is used (only if <samp>PGHOST</samp> is not set).</li>
            <ul>
              <li><a href="#operations--delete-iom">Delete IOM</a></li>
              <li><a href="#operations--delete-postgres">Delete Postgres database</a></li>
              <li><a href="#operations--delete-storage">Remove Local Docker Volume</a>, required only if <samp>KEEP_DATABASE_DATA</samp> is set to <samp>true</samp></li>
              <li><a href="#operations--create-storage">Create Local Docker Volume</a>, required only if <samp>KEEP_DATABASE_DATA</samp> is set to <samp>true</samp></li>
              <li><a href="#operations--create-postgres">Create Postgres Database</a></li>
              <li><a href="#operations--create-iom">Create IOM</a></li>
            </ul>
            <li>The custom dump can only be loaded if the database is empty. When you are using an external database (<samp>PGHOST</samp> is set), the steps listed above will not have any effect. You must take care of purging the external database and recreating the IOM installation yourself.</li>
          </ul>
        </p><p>
          You should inspect the logs created when running the config container to know if the dump was actually loaded. The logs of the configuration process are printed in JSON format. Verbosity can be controlled by the configuration variable <samp>OMS_LOGLEVEL_SCRIPTS</samp>.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
devenv-cli.sh dump load
        </div></code></pre>

        <h3 id="development--dump-create">Create Dump</h3>
        <p>
          Devenv-4-iom provides a job to create a dump of the IOM database. This job uses the variable <samp>CUSTOM_DUMPS_DIR</samp> too. It writes the dumps to this directory. The created dumps use the following naming pattern: <samp>OmsDump.<em>year-month-day.hour.minute.second-hostname</em>.sql.gz</samp>. To create dumps, you have to:
          <ul>
            <li>Set the variable <samp>CUSTOM_DUMPS_DIR</samp> in your configuration file and make sure that the <a href="https://blogs.msdn.microsoft.com/stevelasker/2016/06/14/configuring-docker-for-windows-volumes/" target="_blank">directory is shared in Docker Desktop</a>.
          </ul>
        </p><p>
          You should check the output of the dump job. The logs of the job are printed in JSON format. Verbosity can be controlled by the configuration variable <samp>OMS_LOGLEVEL_SCRIPTS</samp>.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
devenv-cli.sh dump create
        </div></code></pre>
        <p>
          If <samp>CUSTOM_DUMP_DIR</samp> is configured, the latest custom dump is loaded when IOM is started with an empty database (according to the <a href="#development--load-dump">load-rules</a>).
        </p>

        <h3 id="development--access-emails">Access E-Mails</h3>
        <p>To develop e-mail templates to test whether e-mails are successfully sent by business processes and in other use cases, it is necessary to access the e-mails. The information about links to mail server UI and REST interface is given by the command <samp>'info mailserver'</samp>, provided by the command line interface.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
devenv-cli.sh info mailserver
        </div></code></pre>

        <h3 id="development--testing">Testing</h3>

<h4 id="provide-ws-properties">Apply Test-specific Stored Procedures</h4>
        <p>
          To apply stored procedures, simply use the command <a href="#development--apply-sql"><samp>'apply sql-scripts'</samp></a> and set the parameter to the directory containing the stored procedures required for testing.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# oms.tests has to exist in current working directory
devenv-cli.sh apply sql-scripts oms.tests/tc_stored_procedures
        </div></code></pre>

        <h4 id="run-tests">Run Single Geb Tests or a Group of Geb Tests</h4>
        <p> To run a single test, use the the feature name or a substring of it. E.g:</p>

        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# Make sure that geb.properties reflect the latest version of configuration
devenv-cli.sh get geb-props > geb.properties

# Go to the oms.tests directory in your oms source directory
# PATH_TO_IOM_SOURCES and PATH_TO_GEB_PROPERTIES have to be replaced by real values.
cd ${PATH_TO_IOM_SOURCES}/oms.tests

# Run a single geb test
./gradlew gebTest -Pgeb.propFile=${PATH_TO_GEB_PROPERTIES}/geb.properties --tests="IOM: Role Assignment Management: admin_Oms_1 lists users for role-assignment"

# Run a group of geb tests
./gradlew gebTest -Pgeb.propFile=${PATH_TO_GEB_PROPERTIES}/geb.properties --tests="*admin_Oms_1 lists users for role-assignment*"
        </div></code></pre>

        <h4 id="run-tests">Run Single ws Tests or a Group of ws Tests</h4>
        <p> To run a single test, use the the feature name or a substring of it. E.g:</p>

          <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# Make sure that ws.properties reflect the latest version of configuration
devenv-cli.sh get ws-props > ws.properties

# Go to the oms.tests directory in your oms source directory
# PATH_TO_IOM_SOURCES and PATH_TO_WS_PROPERTIES have to be replaced by real values.
cd ${PATH_TO_IOM_SOURCES}/oms.tests

# Run a single ws test
./gradlew wsTest -Pws.propFile=${PATH_TO_WS_PROPERTIES}/ws.properties --tests="IOM-7421-1: OrderService v1.2: Create an order with one position and billing address == shipping address"

# Run a group of ws tests
./gradlew wsTest -Pws.propFile=${PATH_TO_WS_PROPERTIES}/ws.properties --tests="*OrderService v1.2: Create an order with one position and billing address*"
          </div></code></pre>

        <h4 id="run-all-tests">Run all All Tests of a Specification</h4>
        <p> To run all tests of a specification, use the the name of the specification. E.g:</p>

        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# Go to the oms.tests directory in your oms source directory
# PATH_TO_IOM_SOURCES, PATH_TO_GEB_PROPERTIES and PATH_TO_WS_PROPERTIES have to be replaced by real values.
cd ${PATH_TO_IOM_SOURCES}/oms.tests

# Run all tests of a geb test specification
./gradlew gebTest -Pgeb.propFile=${PATH_TO_GEB_PROPERTIES}/geb.properties --tests="*RoleAssignmentManagementListUsersSpec*"

# Run all tests of a ws test specification
./gradlew wsTest -Pws.propFile=${PATH_TO_WS_PROPERTIES}/ws.properties --tests="*ReverseServiceSpec*"
        </div></code></pre>

        <h4 id="run-test-group">Run All Tests of a Group of Specifications (e.g. User Management, Role Management)</h4>
        <p> To run all tests of a group of specifications, just use the name of the used package. E.g:</p>

        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# Go to the oms.tests directory in your oms source directory
# PATH_TO_IOM_SOURCES and PATH_TO_GEB_PROPERTIES have to be replaced by real values.
cd ${PATH_TO_IOM_SOURCES}/oms.tests

# Run all tests of a specification group
./gradlew gebTest -Pgeb.propFile=${PATH_TO_GEB_PROPERTIES}/geb.properties --tests="*com.intershop.oms.tests.roleassignment*"
        </div></code></pre>

        <h4 id="run-test-group">Run SOAP tests</h4>
        <p>To run all soap tests, use the following method:</p>

        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# Make sure that soap.properties reflect the latest version of configuration
devenv-cli.sh get soap-props > soap.properties

# Go to the oms.soap.tests directory in your oms source directory
# PATH_TO_IOM_SOURCES an PATH_TO_SOAP_PROPERTIES have to be replaced by the real values.
cd ${PATH_TO_IOM_SOURCES}/oms.soap.tests

# Run all soap tests
mvn -Dhost=$(cat "${PATH_TO_SOAP_PROPERTIES}/soap.properties") clean test
        </div></code></pre>

        <h2 id="log-messages">Log Messages</h2>
        <h3 id="log-messages--jq">jq - Command Line JSON Processor</h3>
        <p>
          <samp><a href="https://stedolan.github.io/jq/" target="_blank">jq</a></samp> is a command line tool that allows to work with JSON messages. Since all messages created by <samp>devenv-4-iom</samp> and <samp>IOM</samp> are json messages, it is a very useful tool. <samp><a href="https://stedolan.github.io/jq/" target="_blank">jq</a></samp> is not included in <samp>devenv-4-iom</samp>. <samp>devenv-4-iom</samp> does not depend on it (except the <samp>'log *'</samp> commands), but it is strongly recommended that you install <samp><a href="https://stedolan.github.io/jq/" target="_blank">jq</a></samp> too.
        </p><p>
          The most important features used in context of <samp>devenv-4-iom</samp> are formatting and filtering. The following box shows some examples of these use cases. These examples are not intended to be used as they are. They should only give you an impression about <samp><a href="https://stedolan.github.io/jq/" target="_blank">jq</a></samp> and should animate you to dig deeper by yourself.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# Print raw json messages
cmd_producing_json
...
{"tenant":"Intershop","environment":"2.17.0.0-SNAPSHOT","logHost":"iom-6c587ddd87-42k4f","logVersion":"1.0","appName":"iom-config","appVersion":"2.17.0.0-SNAPSHOT@1234","logType":"script","timestamp":"2019-12-13T13:35:45+00:00","level":"INFO","processName":"apply_json_config.sh","message":"processing file '/opt/caas-config/json-config/config/P_shopTX/G_Invoicing_and_Documents/060_InvoicingNoConfigDO/InvoicingNoConfigDO_test_shop_TX.iombc'","configName":"ci"}
{"tenant":"Intershop","environment":"2.17.0.0-SNAPSHOT","logHost":"iom-6c587ddd87-42k4f","logVersion":"1.0","appName":"iom-config","appVersion":"2.17.0.0-SNAPSHOT@1234","logType":"script","timestamp":"2019-12-13T13:35:45+00:00","level":"INFO","processName":"apply_json_config.sh","message":"processing file '/opt/caas-config/json-config/config/P_shopTX/G_Invoicing_and_Documents/120_DocumentTransformerConfigDO/DocumentTransformerConfigDO_Shop_test_shop_TX.iombc'","configName":"ci"}
{"tenant":"Intershop","environment":"2.17.0.0-SNAPSHOT","logHost":"iom-6c587ddd87-42k4f","logVersion":"1.0","appName":"iom-config","appVersion":"2.17.0.0-SNAPSHOT@1234","logType":"script","timestamp":"2019-12-13T13:35:45+00:00","level":"INFO","processName":"apply_json_config.sh","message":"processing file '/opt/caas-config/json-config/config/P_shopTX/H_Shop2PaymentProvider2Payment/010_Shop2PaymentProvider2PaymentDefDO/Shop2PaymentProvider2PaymentDefDO_test_shop_TX.iombc'","configName":"ci"}
...

# Print formatted json messages
cmd_producing_json | jq
...
{
  "tenant": "Intershop",
  "environment": "2.17.0.0-SNAPSHOT",
  "logHost": "iom-6c587ddd87-42k4f",
  "logVersion": "1.0",
  "appName": "iom-config",
  "appVersion": "2.17.0.0-SNAPSHOT@1234",
  "logType": "script",
  "timestamp": "2019-12-13T13:35:45+00:00",
  "level": "INFO",
  "processName": "apply_json_config.sh",
  "message": "processing file '/opt/caas-config/json-config/config/P_shopTX/G_Invoicing_and_Documents/120_DocumentTransformerConfigDO/DocumentTransformerConfigDO_Shop_test_shop_TX.iombc'",
  "configName": "ci"
}
{
  "tenant": "Intershop",
  "environment": "2.17.0.0-SNAPSHOT",
  "logHost": "iom-6c587ddd87-42k4f",
  "logVersion": "1.0",
  "appName": "iom-config",
  "appVersion": "2.17.0.0-SNAPSHOT@1234",
  "logType": "script",
  "timestamp": "2019-12-13T13:35:45+00:00",
  "level": "INFO",
  "processName": "apply_json_config.sh",
  "message": "processing file '/opt/caas-config/json-config/config/P_shopTX/H_Shop2PaymentProvider2Payment/010_Shop2PaymentProvider2PaymentDefDO/Shop2PaymentProvider2PaymentDefDO_test_shop_TX.iombc'",
  "configName": "ci"
}
...

# Get entries, where key "level" has value "ERROR"
cmd_producing_json | jq 'select(.level == "ERROR")'
...
{
  "timestamp": "2019-12-13T11:55:23.608Z",
  "sequence": 1349200,
  "loggerClassName": "org.jboss.logging.DelegatingBasicLogger",
  "loggerName": "org.hibernate.engine.jdbc.spi.SqlExceptionHelper",
  "level": "ERROR",
  "message": "javax.resource.ResourceException: IJ000453: Unable to get managed connection for java:/OmsDB",
  "threadName": "EJB default - 61",
  "threadId": 1113,
  "mdc": {},
  "ndc": "",
  "hostName": "iom-6c587ddd87-zlznn",
  "processName": "jboss-modules.jar",
  "processId": 288,
  "sourceClassName": "org.hibernate.engine.jdbc.spi.SqlExceptionHelper",
  "sourceFileName": "SqlExceptionHelper.java",
  "sourceMethodName": "logExceptions",
  "sourceLineNumber": 142,
  "sourceModuleName": "org.hibernate",
  "sourceModuleVersion": "5.3.10.Final",
  "tenant": "Intershop",
  "environment": "2.17.0.0-SNAPSHOT",
  "logHost": "iom-6c587ddd87-zlznn",
  "logVersion": "1.0",
  "appVersion": "2.17.0.0-SNAPSHOT@1234",
  "appName": "iom-app",
  "logType": "message",
  "configName": "ci"
}
...

# Get entries, where key "level" has value "ERROR" and "sourceModuleName" has value "deployment.oms.monitoring-app-2.17.0.0-SNAPSHOT.war"
cmd_producing_json | jq 'select((.level == "ERROR") and (.sourceModuleName == "deployment.oms.monitoring-app-2.17.0.0-SNAPSHOT.war"))'
...
{
  "timestamp": "2019-12-13T11:50:59.698Z",
  "sequence": 1338700,
  "loggerClassName": "org.slf4j.impl.Slf4jLogger",
  "loggerName": "com.intershop.oms.monitoring.internal.rest.HealthServiceTimer",
  "level": "ERROR",
  "message": "Server not available because of missing database connection.",
  "threadName": "EJB default - 92",
  "threadId": 1222,
  "mdc": {},
  "ndc": "",
  "hostName": "iom-6c587ddd87-zlznn",
  "processName": "jboss-modules.jar",
  "processId": 288,
  "sourceClassName": "com.intershop.oms.monitoring.internal.rest.HealthServiceTimer",
  "sourceFileName": "HealthServiceTimer.java",
  "sourceMethodName": "doHealthCheck",
  "sourceLineNumber": 305,
  "sourceModuleName": "deployment.oms.monitoring-app-2.17.0.0-SNAPSHOT.war",
  "sourceModuleVersion": null,
  "tenant": "Intershop",
  "environment": "2.17.0.0-SNAPSHOT",
  "logHost": "iom-6c587ddd87-zlznn",
  "logVersion": "1.0",
  "appVersion": "2.17.0.0-SNAPSHOT@1234",
  "appName": "iom-app",
  "logType": "message",
  "configName": "ci"
}
...

# Get only values "timestamp" and "message" of entries, where key "level" has value "ERROR"
cmd_producing_json | jq 'select(.level == "ERROR") | .timestamp .message'
...
"2019-12-13T11:49:27.58Z"
"WFLYEJB0034: EJB Invocation failed on component MonitoringPersistenceBean for method public abstract bakery.persistence.dataobject.monitoring.HealthCheckStatusDO bakery.persistence.service.monitoring.MonitoringPersistenceService.getServerStatus(java.lang.String)"
"2019-12-13T11:49:27.624Z"
"WFLYEJB0034: EJB Invocation failed on component MonitoringLogicBean for method public abstract void com.intershop.oms.monitoring.capi.logic.MonitoringLogicService.setServerStatus(com.intershop.oms.monitoring.capi.rest.HealthCheckStatus)"
"2019-12-13T11:49:27.625Z"
" (systemPU) exception found for object 'class bakery.persistence.dataobject.monitoring.HealthCheckStatusDO'"
"2019-12-13T11:49:27.625Z"
"Server not available because of missing database connection."
"2019-12-13T11:49:27.631Z"
"WFLYEJB0022: Error during retrying timeout for timer: [id=9cd75873-66b1-4fdd-8155-fb859d7dc73e timedObjectId=oms.monitoring-app-2.17.0.0-SNAPSHOT.oms.monitoring-app-2.17.0.0-SNAPSHOT.HealthServiceTimer auto-timer?:false persistent?:false timerService=org.jboss.as.ejb3.timerservice.TimerServiceImpl@d537ad6 initialExpiration=Fri Dec 13 11:12:17 UTC 2019 intervalDuration(in milli sec)=5000 nextExpiration=Fri Dec 13 11:49:32 UTC 2019 timerState=RETRY_TIMEOUT info= startAT=Fri Dec 13 11:12:17 UTC 2019, runInterval=5000, cacheTime=11000]"
"2019-12-13T11:49:30.006Z"
"Error"
...

# Get only values "timestamp", "message" and "sourceFileName" of entries, where key "level" has value "ERROR" in a new json structure
cmd_producing_json | jq 'select(.level == "ERROR") | {timestamp: .timestamp, message: .message, sourceFileName: .sourceFileName}'
...
{
  "timestamp": "2019-12-13T11:50:11.467Z",
  "message": "WFLYEJB0034: EJB Invocation failed on component CancelOrderControllerBean for method public abstract void bakery.control.controller.ControllerJob.execute()",
  "sourceFileName": "LoggingInterceptor.java"
}
{
  "timestamp": "2019-12-13T11:50:11.472Z",
  "message": "javax.resource.ResourceException: IJ000453: Unable to get managed connection for java:/OmsDB",
  "sourceFileName": "SqlExceptionHelper.java"
}
{
  "timestamp": "2019-12-13T11:50:11.478Z",
  "message": "WFLYEJB0034: EJB Invocation failed on component CheckBonusPointsControllerBean for method public abstract void bakery.control.controller.ControllerJob.execute()",
  "sourceFileName": "LoggingInterceptor.java"
}
{
  "timestamp": "2019-12-13T11:50:11.486Z",
  "message": "WFLYEJB0034: EJB Invocation failed on component ProcessControlConfigBean for method public abstract java.util.Collection bakery.persistence.service.configuration.process.ProcessControlConfigService.loadModifiedConfigs()",
  "sourceFileName": "LoggingInterceptor.java"
}
...
        </div></code></pre>

        <h3 id="log-messages--devenv">Log Messages of devenv-cli.sh</h3>
        <p>
          Logging of <samp>devenv-cli.sh</samp> is controlled by the configuration variable <samp>OMS_LOGLEVEL_DEVENV</samp>. Since every execution of <samp>devenv-cli.sh</samp> reads the configuration file, changes of this variable become effective immediately.
        </p><p>
          As mentioned <a href="#log-messages--jq">above</a>, all log messages of <samp>devenv-cli.sh</samp> are written in JSON format. Hence, it is a good idea to pipe the output of <samp>devenv-cli.sh</samp> through <samp>jq</samp> for better readability of messages.
        </p><p>
          Unfortunately, it is not as simple as it seems at first glance. There are three reasons that make things more complicated:
          <ul>
            <li>Not every output of <samp>devenv-cli.sh</samp> is a log message, but only log messages are provided in JSON format. <samp>'info *'</samp> and <samp>'get *'</samp> commands and all help-messages are written as plain-text. The intended output of these commands is written to <samp>stdout</samp>. Any additional log messages are written to <samp>stderr</samp>. In fact, all log messages of <samp>devenv-cli.sh</samp> are written to <samp>stderr</samp>.</li>
            <li>Some commands provide a mixture of log messages of <samp>devenv-cli.sh</samp> and <samp>IOM</samp>. Developer commands (<samp>'apply *'</samp>) behave like that. E.g., when applying a SQL configuration using <samp>'apply sql-config'</samp>, there are log messages of <samp>devenv-cli.sh</samp> that are reporting the progress of the process (create kubernetes-job, delete kubernetes-job, etc.). In addition, there are other log messages coming directly from IOM, which provide information about applying the SQL configuration. In this case, only the log messages of <samp>devenv-cli.sh</samp> are controlled by the variable <samp>OMS_LOGLEVEL_DEVENV</samp>. The messages of IOM are controlled by other <samp>OMS_LOGLEVEL_*</samp> variables, see <a href="#log-messages--iom-containers">section below</a>. Beyond that, you should know that log messages of IOM are written to <samp>stdout</samp>, unlike the log messages of <samp>devenv-cli.sh</samp>, which are written to <samp>stderr</samp>.</li>
            <li>Finally, there are the <samp>'log *'</samp> commands, which help to facilitate access to messages created by IOM containers. For more information, see <a href="#log-messages--log-cmd">section below</a>.</li>
          </ul>
        </p><p>
          Hence, the following hints should be taken into account, when using <samp>devenv-cli.sh</samp> along with <samp>jq</samp>:
          <ul>
            <li>When executing commands writing their intended output to <samp>stdout</samp> (e.g. <samp>'info'</samp>, <samp>'get'</samp>), only <samp>stderr</samp> must be redirected to <samp>jq</samp>.</li>
            <li>When executing commands without any intended output (e.g. <samp>'apply'</samp>, <samp>'dump'</samp>), <samp>stdout</samp> and <samp>stderr</samp> must be piped into <samp>jq</samp>.</li>
          </ul>
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# example of jq-usage along with devenv-cli.sh command, having intended output printed to stdout
# intended output is written to file config.properties
# log messages are piped to jq
# creates a pretty-printed version of log messages
devenv-cli.sh get config 2>&1 >config.properties | jq

# example of jq-usage with mixed log messages from devenv-cli.sh and IOM
# log messages of devenv-cli.sh are written to stderr
# log messages of IOM are written to stdout
# both are piped to jq
devenv-cli.sh apply sql-script test.sql 2>&1 | jq
        </div></code></pre>

        <h3 id="log-messages--iom-containers">Log Messages of IOM Containers</h3>
        <p>
          In addition to the IOM application container, two init containers also belong to the IOM. All these containers write messages in JSON format to <samp>stdout</samp>. The log-levels of these messages are controlled by the following variables:
          <ul>
            <li><samp>OMS_LOGLEVEL_CONSOLE</samp></li>
            <li><samp>OMS_LOGLEVEL_IOM</samp></li>
            <li><samp>OMS_LOGLEVEL_HIBERNATE</samp></li>
            <li><samp>OMS_LOGLEVEL_QUARTZ</samp></li>
            <li><samp>OMS_LOGLEVEL_ACTIVEMQ</samp></li>
            <li><samp>OMS_LOGLEVEL_CUSTOMIZATION</samp></li>
            <li><samp>OMS_LOGLEVEL_SCRIPTS</samp></li>
          </ul>
          The values of these log-levels cannot be changed at runtime. For a change to take effect, IOM must be deleted and created again.
        </p><p>
          Beside these application level messages, access logs are written to <samp>stdout</samp> in JSON format too. Hence, the output of the IOM containers is a mixture of different logs.
        </p><p>
          You can use <samp>kubectl</samp> to access these messages. In general these message can be provided in two different ways:
          <ul>
            <li>Get all messages since container start and finish after that, or</li>
            <li>Get only new messages and wait for upcoming messages (follow new messages).</li>
          </ul>
          The according <samp>kubectl</samp> command lines are provided by the <samp>'info iom'</samp> command.
        </p><p>
          Hence, if you use <samp>kubectl</samp> to get log messages of IOM, you will get everything mixed in one stream (messages and access-log), exactly as defined by the current logging configuration. E.g., if a log-level is currently set to <samp>INFO</samp>, but you are interessed in <samp>FATAL</samp>, <samp>ERROR</samp> and <samp>WARN</samp> messages only, you have to write an according <samp>jq</samp> command line by your own to receive only the requested messages (see <a href="log-messages--jq">section jq</a>).
        </p><p>
          The following box shows some examples, how to access log messages of IOM containers and how to filter and format them with the help of <samp>jq</samp>.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# Get all FATAL, ERROR and WARN messages produced by IOM application container (do not follow new messages)
#  kubectl command line was taken from output of 'info iom' command
#  output is filtered by jq
#  - ignore any lines, that are not valid json structures
#  - print only json messages, with 'level' element having the value 'FATAL', 'ERROR' or 'WARN'
kubectl logs iom-6c587ddd87-42k4f --namespace 21700snapshot -c iom |
  jq -R 'fromjson? | select(type == "object")' |
  jq 'select((.level == "FATAL") or (.level == "ERROR") or (.level == "WARN"))'

# Follow new access log entries, having a status code indicating an error
#  kubectl command line was taken from output of 'info iom' command
#  output is filtered by jq
#  - ignore any lines, that are not valid json structures
#  - show only json messages with 'logType' element having the value 'access'
#  - show only json messages with 'responceCode' element having a value greater or equal 400
kubectl logs --tail=1 -f iom-6c587ddd87-42k4f --namespace 21700snapshot -c iom |
  jq -R 'fromjson? | select(type == "object")' |
  jq 'select((.logType == "access" ) and (.responseCode >= 400))'
        </div></code></pre>

        <h3 id="log-messages--log-cmd">devenv-cli's 'log *' Commands</h3>
        <p>
          The <a href="#log-messages--iom-containers">section before</a> showed how to get messages out of the IOM containers and how to further process them with the help of <samp>jq</samp>. This is a valid procedure if special requirements have to be met. However, there are some standard situations that should be easier to handle. For this reason <samp>devenv-cli.sh</samp> provides the <samp>'log *'</samp> commands.
        </p><p>
          The <samp>'log *'</samp> commands facilitate accessing the logs of different IOM containers and different types of logs of IOM's application container. It is the only command that uses <samp>jq</samp> internally to provide a basic filtering and formatting of messages. By using the <samp>'log *'</samp> commands you can do the following:
          <ul>
            <li>View log messages of dbaccount, config or application container:</li>
            <ul>
              <li>Filter them for the passed level and all higher levels. E.g. when level <samp>WARN</samp> is passed as argument to the <samp>log</samp> command, only messages of levels <samp>FATAL</samp>, <samp>ERROR</samp> and <samp>WARN</samp> will be printed.</li>
              <li>Show all messages or follow only new messages.</li>
              <li>Format the messages or leave them unformatted for further processing with <samp>jq</samp>.</li>
            </ul>
            <li>View access logs of application container:</li>
            <ul>
              <li>Filter them for HTTP status code: show all or only those requests, that had an HTTP status code >= 400.</li>
              <li>Show all access log entries or follow only new ones.</li>
              <li>Format the access-log entries or leave them unformatted for further processing with <samp>jq</samp>.</li>
            </ul>
          </ul>
          The following box shows some examples on how to use the <samp>'log *'</samp> commands.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# Show FATAL, ERROR and WARN messages of IOM's config container and format them
devenv-cli.sh log config

# Show INFO messages of IOM's config container and format them
devenv-cli.sh log config info

# Follow FATAL, ERROR and WARN messages of IOM's application container and format the messages
devenv-cli.sh log app -f

# Follow all access log entries
# Do not format messages to be able to process output by a second jq stage that filters for response time > 100 ms
devenv-cli.sh log access all -f | jq 'select(.responseTime > 100)'
        </div></code></pre>

        <h2 id="troubleshooting">Troubleshooting</h2>

        <h3 id="troubleshooting--get-help"><samp>devenv-cli.sh</samp> Help</h3>
        <p>
          <samp>devenv-cli.sh</samp> has a simple system for its command line arguments. In general, each call to <samp>devenv-cli.sh</samp> requires two arguments. These could best be understood as topic and sub-topic. If you append <samp>-h</samp> or <samp>--help</samp> to the command line, you will get detailed help. This works even if no topic or sub-topic is passed on the command line. In this case, the provided help gives information about available topics or sub-topics.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
devenv-cli.sh -h
devenv-cli.sh
    command line interface for configuration with ID test.

SYNOPSIS
    devenv-cli.sh [CONFIG-FILE] COMMAND

CONFIG-FILE
    Name of config-file to be used. If not set, the environment variable
    DEVENV4IOM_CONFIG will be checked. If no config-file can be found, devenv-cli.sh
    ends with an error, with one exception: 'get config'.

COMMANDS
    get|g*             get devenv4iom specific resource
    info|i*            get information about kubernetes resources
    create|c*          create Kubernetes/Docker resources
    delete|de*         delete Kubernetes/Docker resources
    wait|w*            wait for Kubernetes resourses to get ready
    apply|a*           apply customization
    dump|du*           create or load dump
    log|l*             simple access to log-messages

Run 'devenv-cli.sh [CONFIG-FILE] COMMAND --help|-h' for more information on a command.
        </div></code></pre>

        <h3 id="troubleshooting--error-search">IOM is not Working</h3>
        <p>
          "IOM is not working" is a very unspecific description, but it is the most common. For a systematic search for the root cause, you have to know the different stages of starting IOM and how to get detailed information about each stage.
        </p>
        <p>
          The IOM development environment consists of three main components: database, mail server and IOM. If the mail server is not working properly, it will not affect the startup of IOM. Hence, in a situation where IOM is not working at all, we only have to take a look at the database and IOM itself.
        </p>
        <h4>Search for Problems of Postgres Database</h4>
        <p>
          Before searching for a problem, the status of the Postgres database should be checked. The easiest way to do this is to use the <samp>'info postgres'</samp> command. The output of this command contains a section named "Kubernetes", which shows the status of <samp>postgres</samp>. If Postgres is working, the entry "READY" should be "1/1" and the entry "STATUS" should be running, see example below:
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# get information about postgres component
devenv-cli.sh info postgres
...
--------------------------------------------------------------------------------
Kubernetes:
===========
namespace:                  test
KEEP_DATABASE_DATA:         true
NAME       READY   STATUS    RESTARTS   AGE
postgres   1/1     Running   0          74m
--------------------------------------------------------------------------------
...
        </div></code></pre>
        <p>
          If there is no "Kubernetes" section at all, the problem occured in a very early stage, just before the Kubernetes resources were created. E.g. you might have tried to start the system with an invalid configuration. Please check the output of the command you have used to create the Postgres database (<samp>'create cluster'</samp> or <samp>'create postgres'</samp>) for error messages.
        </p><p>
          If there is a "Kubernetes" section but <samp>postgres</samp> is not running or not ready, the start process of the Postgres database has to be investigated. There are two possible causes of the problem:
          <ol>
            <li>The Kubernetes resource cannot be created for a certain reason (e.g. problem accessing the Docker image).</li>
            <li>The Postgres process itself has problems getting into the "ready" state (e.g. Postgres version in not compatible with persistently stored data)</li>
          </ol>
          To get information about these two different stages, two different strategies are necessary:
          <ol>
            <li>Problems of the first category can be seen in the output of the <samp>kubectl describe</samp> command.</li>
            <li>Problems of the second category can be seen when looking at log messages of Postgres.</li>
          </ol>
          The <samp>'info postgres'</samp> command of <samp>devenv-cli.sh</samp> provides you with the neccessary command lines for further investigation. You will find them in the section "Useful commands" as "Describe pod" and "Get logs".
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# get information about postgres component
devenv-cli.sh info postgres
...
--------------------------------------------------------------------------------
Useful commands:
=================
...
Describe pod:               kubectl describe --namespace test pod postgres
Get logs:                   kubectl logs postgres --namespace test
...
--------------------------------------------------------------------------------

# Execute these commands for further investigation
kubectl describe --namespace test pod postgres
...
Events:
  Type    Reason     Age        From                     Message
  ----    ------     ----       ----                     -------
  Normal  Scheduled  <unknown>  default-scheduler        Successfully assigned test/postgres to docker-desktop
  Normal  Pulling    9m11s      kubelet, docker-desktop  Pulling image "postgres:11"
  Normal  Pulled     9m7s       kubelet, docker-desktop  Successfully pulled image "postgres:11"
  Normal  Created    9m7s       kubelet, docker-desktop  Created container postgres
  Normal  Started    9m7s       kubelet, docker-desktop  Started container postgres

kubectl logs postgres --namespace test
...
' 2020-05-22 11:36:15.750 UTC   [1] 'LOG:  listening on IPv4 address "0.0.0.0", port 5432
' 2020-05-22 11:36:15.750 UTC   [1] 'LOG:  listening on IPv6 address "::", port 5432
' 2020-05-22 11:36:15.754 UTC   [1] 'LOG:  listening on Unix socket "/var/run/postgresql/.s.PGSQL.5432"
' 2020-05-22 11:36:15.780 UTC   [26] 'LOG:  database system was interrupted; last known up at 2020-05-22 11:13:26 UTC
' 2020-05-22 11:36:17.036 UTC   [26] 'LOG:  database system was not properly shut down; automatic recovery in progress
' 2020-05-22 11:36:17.042 UTC   [26] 'LOG:  redo starts at 0/31FE868
' 2020-05-22 11:36:17.043 UTC   [26] 'LOG:  invalid record length at 0/3204028: wanted 24, got 0
' 2020-05-22 11:36:17.043 UTC   [26] 'LOG:  redo done at 0/3203FE8
' 2020-05-22 11:36:17.043 UTC   [26] 'LOG:  last completed transaction was at log time 2020-05-22 11:15:51.823575+00
' 2020-05-22 11:36:17.071 UTC   [1] 'LOG:  database system is ready to accept connections
...
        </div></code></pre>
        <h4>Search for Problems of IOM</h4>
        <p>
          The process of searching problems of IOM is in general identical the one used for the Postgres database, with one slight addition: IOM has two init-containers, which may cause problems too. Hence, the process of searching for errors consists of these steps:
          <ol>
            <li>Check IOM's status in Kubernetes.</li>
            <li>If "Kubernetes" section is missing:</li>
            <ol>
              <li>Check <samp>devenv-cli.sh</samp> commands used to create IOM for error messages.</li>
            </ol>
            <li>If "Kubernetes" section is present but IOM is not running or not ready:</li>
            <ol>
              <li>Check output of <samp>kubectl describe</samp> command for errors.</li>
              <li>Check log messages of account initialization for errors (dbaccount init-container).</li>
              <li>Check log messages of database configuration for errors (config init-container).</li>
              <li>Check log messages of IOM for errors.</li>
            </ol>
          </ol>
          According to the checklist above, the first step gets the status of IOM. This can be easily done by using the <samp>'info iom'</samp> command. The "Kubernetes" section in the output shows the current status. If everything is fine, "READY" should be "1/1" and "STATUS" shoulb be "Running".
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
devenv-cli.sh info iom
...
--------------------------------------------------------------------------------
Kubernetes:
===========
namespace:                  test
NAME                   READY   STATUS    RESTARTS   AGE
iom-849dcb5d88-6dnss   1/1     Running   0          60m
--------------------------------------------------------------------------------
...
        </div></code></pre>
        <p>
          If there is no "Kubernetes" section at all, the problem occured in a very early stage, just before the Kubernetes resources were created. E.g. you might have tried to start the system with an invalid configuration. Please check the output of the command you have used to create IOM ('create cluster' or 'create iom') for error messages.
        </p><p>
          If there is a "Kubernetes" section but IOM is not running or not ready, the start process of IOM has to be investigated. There are the following possible causes of the problem:
          <ol>
            <li>The Kubernetes resource cannot be created for a certain reason (e.g. problem accessing the Docker image).</li>
            <li>The dbaccount init-container has problems to be executed successfully (e.g. wrong credentials).</li>
            <li>The config init-container has problems to be executed successfully (e.g. missing database dump).</li>
            <li>The IOM server itself has problems to get in "ready" state (e.g. erroneous deployment artifact).</li>
          </ol>
          To get information about these different stages, according strategies have to be used:
          <ol>
            <li>Problems of the first category can be found in the output of the <samp>kubectl describe</samp> command.</li>
            <li>Problems with the dbaccount init-container can be found by checking the output of the container for error messages.</li>
            <li>Problems with the config init-container can be found by checking the output of the container for error messages.</li>
            <li>Problems with the IOM server can be found by checking the output of the IOM container for error messages.</li>
          </ol>
          The <samp>'info iom'</samp> command provides you the neccessary command line to investigate the actions made by Kubernetes when starting IOM. The <samp>'log *'</samp> commands of <samp>devenv-cli.sh</samp> provide access to the log messages created by containers belonging to IOM.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# Get information about IOM
devenv-cli.sh info iom
...
--------------------------------------------------------------------------------
Useful commands:
=================
...
Describe iom pod:           kubectl describe --namespace test pod iom-849dcb5d88-6dnss
Describe iom deployment     kubectl describe --namespace test deployment iom
...
--------------------------------------------------------------------------------

# Execute these commands for further investigation
kubectl describe --namespace test pod iom-849dcb5d88-6dnss
...
QoS Class:       BestEffort
Node-Selectors:  &lt;none&gt;
Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
                 node.kubernetes.io/unreachable:NoExecute for 300s
Events:          &lt;none&gt;

kubectl describe --namespace test deployment iom
...
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  &lt;none&gt;
NewReplicaSet:   iom-849dcb5d88 (1/1 replicas created)
Events:          &lt;none&gt;
        </div></code></pre>
        <p>
          The easiest method to get log messages out of containers is using the <samp>'log *'</samp> commands, provided by <samp>devenv-cli.sh</samp>. If called without further parameters, only messages of levels <samp>ERROR</samp> and <samp>FATAL</samp> are displayed, which makes it easy to find errors. You can use these commands only if <samp>jq</samp> is properly installed.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# Show error messages of the dbaccout init-container
devenv-cli.sh log dbaccount
...

# Show error messages of the config init-container
devenv-cli.sh log config
...

# Show error messages of the iom application server
devenv-cli.sh log app
...
        </div></code></pre>
        <p>
          Unexpected errors may occur that are not handled properly. These errors cannot be found by using the <samp>'log *'</samp> commands. To find such errors, the raw output of containers has to be investigated. If you do not have <samp>jq</samp> properly installed, you have to use this basic access to log messages as well. The according command lines are provided by <samp>'info iom'</samp> within the section "Useful commands".
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
devenv-cli.sh info iom
...
--------------------------------------------------------------------------------
Useful commands:
=================
...
Get dbaccount logs:         kubectl logs iom-849dcb5d88-6dnss --namespace test -c dbaccount
Get config logs:            kubectl logs iom-849dcb5d88-6dnss --namespace test -c config
Get iom logs:               kubectl logs iom-849dcb5d88-6dnss --namespace test -c iom
...
--------------------------------------------------------------------------------
        </div></code></pre>

        <h3 id="troubleshooting--manual-cleanup">Manual Cleanup</h3>
        <p>
          According to section <a href="#configurations--delete-config">"Delete a Configuration"</a>, a configuration must not be deleted, while according Kubernetes and Docker resources still exist. If you are in a situation, where the configuration file is deleted and resources belonging to this configuration still exist, you have to delete these resources manually. In general, you have to proceed the following steps:
          <ol>
            <li>Search and delete orphaned Kubernetes namespaces.</li>
            <li>Delete orphaned Docker volumes.</li>
          </ol>
        </p>
        <h4>Search and delete orphaned Kubernetes namespaces</h4>
        <p>
          All Kubernetes resources belonging to a configuration, are assigned to one Kubernetes namespace. The name of this namespace is derived from <samp>ID</samp> defined in configuration file. In order to create a valid name for namespace, all non-alphanumerical characters are stripped from <samp>ID</samp> and the remaining characters are transformed to lowercase. E.g., if you had used <samp>CustomerProject IOM 3.0.0.0</samp> for <samp>ID</samp>, the derived name of namespace is <samp>customerprojectiom3000</samp>.
        </p><p>
          Kubernetes uses namespaces for own purposes. To avoid any conflict with these namespaces, <samp>devenv-4-iom</samp> will not allow you to use an <samp>ID</samp>, that starts with on of: <samp>default</samp>, <samp>docker</samp>, <samp>kube</samp>. Hence, the orphaned Kubernetes namespace we are searching, will NEVER start with one of these thress phrases.
        </p><p>
          The following box shows how to list all existing namespaces. According to the naming rules of namespaces created by <samp>devenv-4-iom</samp>, only two entries in the list of results are of interest: <samp>customerprojectiom3000</samp> and <samp>oldprojectiom3000</samp>. If you know the <samp>ID</samp>s of your currently existing configurations, you can find out the name of the orphaned namespace. In our example <samp>oldprojectiom3000</samp> is the one we have searched for.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# list all existing Kubernetes namespaces
kubectl get namespace         
NAME                     STATUS   AGE
customerprojectiom3000   Active   40m
default                  Active   28d
docker                   Active   28d
kube-node-lease          Active   28d
kube-public              Active   28d
kube-system              Active   28d
oldprojectiom3000        Active   10d

# delete orphaned Kubernetes namespace
kubectl delete namespace oldprojectiom3000
namespace "oldprojectiom3000" deleted
        </div></code></pre>

        <h4>Delete orphaned Docker volumes</h4>
        <p>
          Docker volumes are used to provide persistent storage for the PostgreSQL database server. Since the usage of persistent storage is optional, an orphaned Docker volume might not exist at all. Once you have found the name of an orphaned Kubernetes namespace, it is very simple to find out whether an according Docker volume exists or not. The name of the Docker volume is derived from <samp>ID</samp> too. The same rules are applied to the <samp>ID</samp> as described above, additionally the prefix <samp>-pgdata</samp> is appended.
        </p><p>
          Hence, if the orphaned Kubernetes namespaces is <samp>oldprojectiom3000</samp>, the according Docker volume is named <samp>oldprojectiom3000-pgdata</samp>. The following command lists all Docker volumes and shows you, how to delete the one Docker volume, you have identified before.
        </p>
        <pre class="prettyprint lang-bash"><code><div class="col-xs-12">
# list all existing Docker volumes
docker volume ls -q
008e5dc60890b954a68de526da1ba73113143b8dcb9edbf382db585cb7cf2736
customerprojectiom3000-pgdata
oldprojectiom3000-pgdata

# delete orphaned Docker volume
docker volume rm oldprojectiom3000-pgdata
oldprojectiom3000-pgdata
        </div></code></pre>  
        
        <h3 id="troubleshooting--shared-drives">Shared Drives</h3>
        <p>
          After resetting your password you may experience problems with your shared drives. In those cases go to Settings > Shared Drives > Reset credentials
        </p>

        <h3 id="troubleshooting--wrong-context">Wrong Kubernetes Context</h3>
        <p>
          kubectl can interact with more than one Kubernetes cluster by setting the context. If <samp>devenv-cli.sh</samp> does not work properly, a wrong context might be the cause.
        </p>
        <pre class="prettyprint long-bash"><code><div class="col-xs-12">
# List the existing contexts
# Look out for entry "current-context". It should be set to docker-desktop
kubectl config view

# Change context to docker-desktop
kubectl config use-context docker-desktop
        </div></code></pre>
        <p>
          When using Docker-Desktop, this setting can be easily changed using the "Kubernetes" menu entry. It lists all existing contexts. You just have to select the right one: "docker-desktop".
        </p>
      <br><br>

      </div> <!-- /container -->


      <!-- Bootstrap core JavaScript
      ================================================== -->
      <!-- Placed at the end of the document so the pages load faster -->
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
      <script>window.jQuery || document.write('<script src="../../assets/js/vendor/jquery.min.js"><\/script>')</script>

      <script>

          // toogle icon and title
          function toggleAliasButton(e) {

              var icon = $(e.target);
              var button = icon.parent();

              // if the button was clicked instead of the icon
              if($(e.target).children('i').length) {
                  button = $(e.target);
                  icon = button.find('i');
              }

              icon.toggleClass('fa-plus');
              icon.toggleClass('fa-minus');

              var title = 'Show aliases';

              if( icon.hasClass('fa-minus')){
                 title = 'Hide aliases';
              }

              button.attr('title', title);
          }
          $('.alias-toggle').on('click', toggleAliasButton);

      </script>

      <!-- Latest compiled and minified JavaScript -->
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    </body>
</html>
